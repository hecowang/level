<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­éŸ³äº¤äº’å®¢æˆ·ç«¯</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
        }
        
        .auth-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .auth-form {
            display: grid;
            gap: 15px;
            grid-template-columns: 1fr auto;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: 500;
            color: #333;
        }
        
        input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #4facfe;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        
        button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #28a745; }
        .status-disconnected { background: #dc3545; }
        .status-connecting { background: #ffc107; }
        
        .chat-section {
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .message {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.4;
        }
        
        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .message-assistant {
            align-self: flex-start;
            background: #f1f3f5;
            color: #333;
        }
        
        .message-system {
            align-self: center;
            background: #e9ecef;
            color: #666;
            font-size: 12px;
            text-align: center;
        }
        
        .input-section {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 14px;
        }
        
        .voice-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .voice-btn:hover {
            transform: scale(1.05);
        }
        
        .voice-btn.recording {
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .mic-icon {
            width: 24px;
            height: 24px;
            fill: white;
        }
        
        .send-btn {
            padding: 12px 24px;
            border-radius: 25px;
        }
        
        .audio-player {
            margin-top: 5px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ™ï¸ è¯­éŸ³äº¤äº’å®¢æˆ·ç«¯</h1>
            <p>æ”¯æŒæ–‡æœ¬å’Œè¯­éŸ³è¾“å…¥çš„æ™ºèƒ½å¯¹è¯ç³»ç»Ÿ</p>
        </div>
        
        <div class="auth-section">
            <div class="auth-form">
                <div class="input-group">
                    <label for="apiKey">API Key:</label>
                    <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥APIå¯†é’¥">
                </div>
                <button id="authBtn" onclick="authenticate()">è®¤è¯</button>
                
                <div class="input-group">
                    <label for="deviceId">Device ID:</label>
                    <input type="text" id="deviceId" placeholder="è¯·è¾“å…¥è®¾å¤‡ID">
                </div>
                <button id="registerBtn" onclick="registerDevice()" disabled>æ³¨å†Œè®¾å¤‡</button>
            </div>
        </div>
        
        <div class="status">
            <div>
                <span class="status-indicator status-disconnected"></span>
                <span id="connectionStatus">æœªè¿æ¥</span>
            </div>
            <div>
                <span id="stateDisplay">çŠ¶æ€: æœªè®¤è¯</span>
            </div>
        </div>
        
        <div class="chat-section" id="chatContainer">
            <div class="message message-system">
                æ¬¢è¿ä½¿ç”¨è¯­éŸ³äº¤äº’ç³»ç»Ÿï¼è¯·å…ˆå®ŒæˆAPIå¯†é’¥è®¤è¯å’Œè®¾å¤‡æ³¨å†Œã€‚
            </div>
        </div>
        
        <div class="input-section">
            <input type="text" id="chatInput" class="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
            <div class="voice-btn" id="voiceBtn" title="è¯­éŸ³è¾“å…¥">
                <svg class="mic-icon" viewBox="0 0 24 24">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                    <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                </svg>
            </div>
            <button id="sendBtn" class="send-btn" onclick="sendMessage()" disabled>å‘é€</button>
        </div>
    </div>

    <script>
        let ws = null;
        let currentState = 'init';
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        
        const apiKeyInput = document.getElementById('apiKey');
        const deviceIdInput = document.getElementById('deviceId');
        const authBtn = document.getElementById('authBtn');
        const registerBtn = document.getElementById('registerBtn');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const voiceBtn = document.getElementById('voiceBtn');
        const chatContainer = document.getElementById('chatContainer');
        const connectionStatus = document.getElementById('connectionStatus');
        const stateDisplay = document.getElementById('stateDisplay');
        const statusIndicator = document.querySelector('.status-indicator');
        
        // åˆå§‹åŒ–WebSocketè¿æ¥
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/api/v1/agent/chat`;
            
            ws = new WebSocket(wsUrl);
            updateConnectionStatus('connecting', 'è¿æ¥ä¸­...');
            
            ws.onopen = () => {
                updateConnectionStatus('connected', 'å·²è¿æ¥');
                addSystemMessage('WebSocketè¿æ¥å·²å»ºç«‹ï¼Œè¯·è¿›è¡Œè®¤è¯');
            };
            
            ws.onmessage = (event) => {
                try {
                    const response = JSON.parse(event.data);
                    handleServerResponse(response);
                } catch (e) {
                    console.error('è§£ææ¶ˆæ¯å¤±è´¥:', e);
                    addSystemMessage('æ”¶åˆ°éJSONæ¶ˆæ¯: ' + event.data);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
                updateConnectionStatus('disconnected', 'è¿æ¥é”™è¯¯');
                addSystemMessage('è¿æ¥å‘ç”Ÿé”™è¯¯');
            };
            
            ws.onclose = () => {
                updateConnectionStatus('disconnected', 'è¿æ¥å·²æ–­å¼€');
                addSystemMessage('è¿æ¥å·²æ–­å¼€');
                resetUI();
            };
        }
        
        // å¤„ç†æœåŠ¡å™¨å“åº”
        function handleServerResponse(response) {
            console.log('æ”¶åˆ°æœåŠ¡å™¨å“åº”:', response);
            
            switch (response.type) {
                case 'auth':
                    if (response.status === 'success') {
                        addSystemMessage('APIå¯†é’¥è®¤è¯æˆåŠŸ');
                        updateState(response.data?.state || 'authenticated');
                        registerBtn.disabled = false;
                    } else {
                        addSystemMessage('è®¤è¯å¤±è´¥: ' + response.message, 'error');
                    }
                    break;
                    
                case 'register':
                    if (response.status === 'success') {
                        addSystemMessage('è®¾å¤‡æ³¨å†ŒæˆåŠŸï¼Œå¯ä»¥å¼€å§‹èŠå¤©äº†ï¼');
                        updateState(response.data?.state || 'ready');
                        chatInput.disabled = false;
                        sendBtn.disabled = false;
                        voiceBtn.style.cursor = 'pointer';
                    } else {
                        addSystemMessage('æ³¨å†Œå¤±è´¥: ' + response.message, 'error');
                    }
                    break;
                    
                case 'chat':
                    if (response.status === 'success') {
                        addMessage(response.data?.response || 'æ”¶åˆ°å›å¤', 'assistant');
                        if (response.data?.audio) {
                            // å¤„ç†éŸ³é¢‘å›å¤
                            playAudio(response.data.audio);
                        }
                    } else {
                        addSystemMessage('èŠå¤©é”™è¯¯: ' + response.message, 'error');
                    }
                    break;
                    
                case 'error':
                    addSystemMessage('é”™è¯¯: ' + response.message, 'error');
                    break;
                    
                default:
                    addSystemMessage(`[${response.type}] ${response.message}`);
            }
        }
        
        // è®¤è¯APIå¯†é’¥
        function authenticate() {
            const apiKey = apiKeyInput.value.trim();
            if (!apiKey) {
                addSystemMessage('è¯·è¾“å…¥APIå¯†é’¥', 'error');
                return;
            }
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                connectWebSocket();
                // ç­‰å¾…è¿æ¥å»ºç«‹åå†å‘é€è®¤è¯
                setTimeout(() => authenticate(), 1000);
                return;
            }
            
            sendJSONMessage('auth', { api_key: apiKey });
            addSystemMessage('æ­£åœ¨è®¤è¯APIå¯†é’¥...');
        }
        
        // æ³¨å†Œè®¾å¤‡
        function registerDevice() {
            const deviceId = deviceIdInput.value.trim();
            if (!deviceId) {
                addSystemMessage('è¯·è¾“å…¥è®¾å¤‡ID', 'error');
                return;
            }
            
            sendJSONMessage('register', { device_id: deviceId });
            addSystemMessage('æ­£åœ¨æ³¨å†Œè®¾å¤‡...');
        }
        
        // å‘é€æ–‡æœ¬æ¶ˆæ¯
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) {
                addSystemMessage('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
                return;
            }
            
            sendJSONMessage('chat', { 
                content: message, 
                message_type: 'text' 
            });
            
            addMessage(message, 'user');
            chatInput.value = '';
        }
        
        // åˆå§‹åŒ–è¯­éŸ³å½•åˆ¶
        async function initVoiceRecording() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                addSystemMessage('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³å½•åˆ¶', 'error');
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await sendAudioMessage(audioBlob);
                    audioChunks = [];
                };
                
                voiceBtn.onclick = toggleRecording;
                
            } catch (error) {
                console.error('åˆå§‹åŒ–è¯­éŸ³å½•åˆ¶å¤±è´¥:', error);
                addSystemMessage('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®', 'error');
            }
        }
        
        // åˆ‡æ¢å½•éŸ³çŠ¶æ€
        function toggleRecording() {
            if (currentState !== 'ready' && currentState !== 'chatting') {
                addSystemMessage('è¯·å…ˆå®Œæˆè®¤è¯å’Œæ³¨å†Œ', 'error');
                return;
            }
            
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        }
        
        // å¼€å§‹å½•éŸ³
        function startRecording() {
            if (mediaRecorder && mediaRecorder.state === 'inactive') {
                audioChunks = [];
                mediaRecorder.start();
                isRecording = true;
                voiceBtn.classList.add('recording');
                addSystemMessage('å½•éŸ³ä¸­...');
            }
        }
        
        // åœæ­¢å½•éŸ³
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                isRecording = false;
                voiceBtn.classList.remove('recording');
                addSystemMessage('å½•éŸ³ç»“æŸï¼Œæ­£åœ¨å‘é€...');
            }
        }
        
        // å‘é€éŸ³é¢‘æ¶ˆæ¯
        async function sendAudioMessage(audioBlob) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addSystemMessage('è¯·å…ˆå»ºç«‹è¿æ¥', 'error');
                return;
            }
            
            try {
                const arrayBuffer = await audioBlob.arrayBuffer();
                ws.send(arrayBuffer);
                addSystemMessage('éŸ³é¢‘æ¶ˆæ¯å·²å‘é€');
            } catch (error) {
                console.error('å‘é€éŸ³é¢‘å¤±è´¥:', error);
                addSystemMessage('å‘é€éŸ³é¢‘å¤±è´¥', 'error');
            }
        }
        
        // æ’­æ”¾éŸ³é¢‘
        function playAudio(audioData) {
            // è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„éŸ³é¢‘æ•°æ®æ ¼å¼è¿›è¡Œå¤„ç†
            addSystemMessage('æ”¶åˆ°éŸ³é¢‘å›å¤');
        }
        
        // å‘é€JSONæ¶ˆæ¯
        function sendJSONMessage(type, data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type, data }));
                return true;
            }
            addSystemMessage('WebSocketæœªè¿æ¥', 'error');
            return false;
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = text;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(text, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-system ${type}`;
            messageDiv.textContent = text;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, text) {
            connectionStatus.textContent = text;
            statusIndicator.className = 'status-indicator';
            statusIndicator.classList.add(`status-${status}`);
        }
        
        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateState(state) {
            currentState = state;
            const stateText = {
                'init': 'æœªè®¤è¯',
                'authenticated': 'å·²è®¤è¯',
                'ready': 'å‡†å¤‡å°±ç»ª',
                'chatting': 'èŠå¤©ä¸­'
            }[state] || state;
            
            stateDisplay.textContent = `çŠ¶æ€: ${stateText}`;
        }
        
        // é‡ç½®UIçŠ¶æ€
        function resetUI() {
            registerBtn.disabled = true;
            chatInput.disabled = true;
            sendBtn.disabled = true;
            voiceBtn.style.cursor = 'not-allowed';
            updateState('init');
        }
        
        // åˆå§‹åŒ–
        function init() {
            // å›è½¦å‘é€æ¶ˆæ¯
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // åˆå§‹åŒ–è¯­éŸ³å½•åˆ¶
            initVoiceRecording();
            
            // è‡ªåŠ¨è¿æ¥WebSocket
            connectWebSocket();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>